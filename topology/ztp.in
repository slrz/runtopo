#!/bin/bash
# CUMULUS-AUTOPROVISIONING
# The previous line is a required part, do not drop it.

fatal() {
        echo "$0:$BASH_LINENO: fatal: $BASH_COMMAND" >&2
        exit 1
}

# Write log to keep track of errors
exec >>/var/log/ztp-script.log 2>&1
date -u "+%FT%T ztp starting script $0"
trap fatal ERR


# NCLU might not be usable yet, loop until it is.
ec=1
while test "$ec" -ne 0; do
    net show interface &> /dev/null
    ec=$?
done

mkdir -p /home/cumulus/.ssh
cat >>/home/cumulus/.ssh/authorized_keys <<'EOF'
{{ .AuthorizedKeys }}
EOF
chown -R cumulus:cumulus /home/cumulus/.ssh

passwd -x 99999 cumulus # unexpire account (needed for CL4)
echo '%sudo     ALL=(ALL:ALL) NOPASSWD: ALL' >/etc/sudoers.d/no-passwd


# Ed^H^HVi is the standard text editor
ed=/usr/bin/vim.basic
if ! test -x $ed; then
        ed=/usr/bin/vim.tiny
fi

update-alternatives --set  editor "$ed"

net add time zone Etc/UTC
net commit
